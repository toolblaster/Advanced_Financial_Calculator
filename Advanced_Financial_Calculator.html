<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .calculator-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 38rem; /* Reverted max-width to a single column design */
            margin: 2rem auto;
            border: 1px solid #e5e7eb;
        }
        .input-card {
            background-color: #f9fafb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-card:hover {
            border-color: #E34037;
            box-shadow: 0 0 0 1px #FCA5A5;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .input-card input[type="number"], .input-card select {
            border: 1px solid #E34037;
            background-color: white;
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-card input[type="number"]:focus, .input-card select:focus {
            outline: none;
            border-color: #E34037;
            box-shadow: 0 0 0 2px rgba(227, 64, 55, 0.5);
        }
        .btn-primary {
            background-color: #E34037;
            color: white;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #bb2c22;
        }
        .result-box {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 500;
            text-align: center;
        }
        .faded {
            opacity: 0.4;
            pointer-events: none;
            user-select: none;
        }
        .disabled-input {
            cursor: not-allowed;
            background-color: #e5e7eb;
        }
        .error {
            color: #ef4444;
            font-weight: 500;
        }
        /* Custom slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #E34037 var(--fill-percentage, 0%), #e5e7eb var(--fill-percentage, 0%));
            border-radius: 5px;
            outline: none;
            transition: background 0.2s;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #E34037;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(227, 64, 55, 0.3);
            transition: background 0.2s;
        }
        .pill-toggle-container {
            display: flex;
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: #fecaca;
            border: 1px solid #fca5a5;
        }
        .pill-toggle-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            text-align: center;
        }
        .pill-toggle-btn.active {
            background-color: #E34037;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }

        /* Tooltip Styles */
        .info-tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .info-icon {
            cursor: pointer;
            flex-shrink: 0; /* Prevents icon from shrinking */
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: 400;
            pointer-events: none; /* Prevents the tooltip from blocking clicks */
        }
        .info-tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Enhanced Result Display Styles */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .result-card {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .result-card .label {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
         .result-card .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .result-card .icon {
            margin-right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
        }
        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #E34037;
        }
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #E34037;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        /* Collapsible Section */
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible.open {
            max-height: 100px; /* Adjust if content is taller */
        }
        .result-details-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .result-details-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                align-items: center;
                gap: 1.5rem;
            }
        }
    </style>
</head>
<body class="p-4">

    <div class="text-center my-4">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Financial Calculator</h1>
        <p class="mt-2 text-lg text-gray-500">Plan your investments and retirement with advanced analysis.</p>
    </div>

    <!-- Unified Calculator -->
    <div class="calculator-card">
        <div class="flex justify-center mb-4">
             <div class="pill-toggle-container">
                <button id="lumpsumToggleBtn" class="pill-toggle-btn active">Lump-Sum</button>
                <button id="sipToggleBtn" class="pill-toggle-btn">SIP</button>
                <button id="fdToggleBtn" class="pill-toggle-btn">FD</button>
            </div>
        </div>

        <h2 id="calculatorTitle" class="text-2xl font-semibold text-gray-800 mb-4 text-center">Lump-Sum Investment</h2>
        
        <div class="flex flex-col gap-4">
            <!-- Top Section: Step 1 Inputs -->
            <div class="space-y-2">
                <h3 class="text-lg font-semibold text-gray-700">Step 1: Grow Your Investment</h3>
                
                <div class="input-card flex flex-col">
                    <label id="mainAmountLabel" for="mainAmountInput" class="mb-1 info-tooltip-container">
                        <span id="mainAmountLabelText">Lump-Sum Amount (₹):</span>
                        <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span id="mainAmountTooltip" class="tooltip-text">The total single amount you plan to invest at the beginning.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="mainAmountSlider" min="1000" max="10000000" step="1000" value="100000" class="flex-1">
                        <input type="number" id="mainAmountInput" placeholder="e.g., 100000" class="w-2/5" value="100000">
                    </div>
                </div>

                <div class="input-card flex flex-col">
                    <label for="investmentYearsInput" class="mb-1 info-tooltip-container">Investment Period (Years):
                        <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span class="tooltip-text">The total number of years you plan to keep your money invested to let it grow.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="investmentYearsSlider" min="1" max="50" step="1" value="10" class="flex-1">
                        <input type="number" id="investmentYearsInput" placeholder="e.g., 10" class="w-2/5" value="10">
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <label for="annualRateInput" class="mb-1 info-tooltip-container">Expected Annual Return (%)
                        <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span class="tooltip-text">This is the average return you expect from your investment each year. Equity funds average 12-15%, while FDs are around 6-7%.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="annualRateSlider" min="1" max="30" step="0.1" value="12" class="flex-1">
                        <input type="number" id="annualRateInput" placeholder="e.g., 12" class="w-2/5" value="12">
                    </div>
                    <div class="flex justify-between mt-2 space-x-2">
                        <button data-rate="14" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Equity (14%)</button>
                        <button data-rate="10" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Hybrid (10%)</button>
                        <button data-rate="7" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Debt (7%)</button>
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <div class="flex justify-between items-center cursor-pointer" id="inflationHeader">
                        <label for="inflationRateInput" class="info-tooltip-container">Expected Annual Inflation (%)
                            <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                            <span class="tooltip-text">Inflation is the rate at which prices for goods and services rise, reducing the purchasing power of your money. India's long-term average is around 6%.</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="inflationToggle">
                            <span class="toggle-slider"></span>
                        </label>
                     </div>
                    <div id="inflationInputsContainer" class="collapsible">
                        <div class="flex items-center space-x-2 pt-2 mt-2 border-t">
                            <input type="range" id="inflationRateSlider" min="0" max="15" step="0.1" value="6" class="flex-1">
                            <input type="number" id="inflationRateInput" placeholder="e.g., 6" class="w-2/5" value="6">
                        </div>
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <div class="flex justify-between items-center cursor-pointer" id="taxHeader">
                        <label for="taxRateInput" class="info-tooltip-container">Tax Rate (%)
                            <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                            <span class="tooltip-text">The tax applied to your investment gains. For FDs, it's as per your income slab. For stocks/mutual funds, long-term capital gains tax is typically 10%.</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="taxToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="taxInputsContainer" class="collapsible">
                        <div class="flex items-center space-x-2 pt-2 mt-2 border-t">
                            <input type="range" id="taxRateSlider" min="0" max="50" step="1" value="10" class="flex-1">
                            <input type="number" id="taxRateInput" placeholder="e.g., 10" class="w-2/5" value="10">
                        </div>
                    </div>
                </div>
                <button id="calculateCorpusBtn" class="btn-primary w-full mt-4">Calculate Corpus</button>
            </div>

            <!-- Bottom Section: Results and Step 2 Inputs -->
            <div class="space-y-2">
                 <div id="resultBox" class="result-box hidden">
                    <!-- Step 1 Result -->
                    <div id="corpusResult" class="mb-4 text-gray-800"></div>
                    
                    <!-- Chart Container -->
                    <div class="w-full mb-6">
                        <canvas id="corpusChart"></canvas>
                    </div>

                    <!-- Step 2 Inputs (Faded by default) -->
                    <div id="incomeSection" class="faded">
                        <hr class="my-4 border-gray-300">
                        <h3 class="text-lg font-semibold text-gray-700">Step 2: Plan Your Withdrawals</h3>

                        <div class="flex justify-center my-4">
                            <div class="pill-toggle-container">
                               <div class="info-tooltip-container mx-1">
                                   <button id="longevityToggleBtn" class="pill-toggle-btn active flex items-center justify-center">
                                       <span>Calculate Longevity</span>
                                       <svg class="info-icon ml-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                   </button>
                                   <span class="tooltip-text">Calculates how many years your corpus will last if you withdraw a fixed amount regularly.</span>
                               </div>
                               <div class="info-tooltip-container mx-1">
                                   <button id="amountToggleBtn" class="pill-toggle-btn flex items-center justify-center">
                                       <span>Calculate Withdrawal</span>
                                       <svg class="info-icon ml-2" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                   </button>
                                   <span class="tooltip-text">Calculates the maximum amount you can withdraw regularly for a fixed number of years.</span>
                               </div>
                           </div>
                       </div>

                        <div class="space-y-2 mt-4">
                            <div id="longevityInputs">
                                <div class="input-card flex flex-col mb-4">
                                    <label for="withdrawalAmount" class="mb-1">Desired Withdrawal Amount:</label>
                                    <input type="number" id="withdrawalAmount" placeholder="e.g., 50000" class="w-full">
                                </div>
                                <div class="input-card flex items-center justify-between mb-4 p-3">
                                     <label for="increasingToggle" class="mb-0">Increase withdrawals with inflation?</label>
                                     <label class="toggle-switch">
                                         <input type="checkbox" id="increasingToggle">
                                         <span class="toggle-slider"></span>
                                     </label>
                                </div>
                            </div>

                            <div id="amountInputs" class="hidden">
                                <div class="input-card flex flex-col mb-4">
                                    <label for="sustainedYears" class="mb-1">Withdraw For How Many Years?</label>
                                    <input type="number" id="sustainedYears" placeholder="e.g., 20" class="w-full">
                                </div>
                            </div>

                            <div class="input-card flex flex-col mb-4">
                                <label for="incomeFrequency" class="mb-1">Withdrawal Frequency:</label>
                                <select id="incomeFrequency" class="w-full">
                                    <option value="12">Monthly</option>
                                    <option value="4">Quarterly</option>
                                    <option value="2">Half-Yearly</option>
                                    <option value="1">Yearly</option>
                                </select>
                            </div>

                            <button id="calculateFixedIncomeBtn" class="btn-primary w-full">Calculate</button>
                            <div id="incomeResult" class="mt-4 text-gray-800"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="resetBtn" class="btn-primary mt-4 hidden px-12">Reset Calculator</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getElem = (id) => document.getElementById(id);
            const lumpsumToggleBtn = getElem('lumpsumToggleBtn');
            const sipToggleBtn = getElem('sipToggleBtn');
            const fdToggleBtn = getElem('fdToggleBtn');
            const calculatorTitle = getElem('calculatorTitle');
            const mainAmountLabel = getElem('mainAmountLabel');
            const mainAmountLabelText = getElem('mainAmountLabelText');
            const mainAmountTooltip = getElem('mainAmountTooltip');
            const mainAmountInput = getElem('mainAmountInput');
            const mainAmountSlider = getElem('mainAmountSlider');
            const investmentYearsInput = getElem('investmentYearsInput');
            const investmentYearsSlider = getElem('investmentYearsSlider');
            const annualRateInput = getElem('annualRateInput');
            const annualRateSlider = getElem('annualRateSlider');
            const inflationRateInput = getElem('inflationRateInput');
            const inflationRateSlider = getElem('inflationRateSlider');
            const inflationToggle = getElem('inflationToggle');
            const inflationInputsContainer = getElem('inflationInputsContainer');
            const inflationHeader = getElem('inflationHeader');
            const taxRateInput = getElem('taxRateInput');
            const taxRateSlider = getElem('taxRateSlider');
            const taxToggle = getElem('taxToggle');
            const taxInputsContainer = getElem('taxInputsContainer');
            const taxHeader = getElem('taxHeader');
            const calculateCorpusBtn = getElem('calculateCorpusBtn');
            const calculateFixedIncomeBtn = getElem('calculateFixedIncomeBtn');
            
            // Withdrawal Section Elements
            const longevityToggleBtn = getElem('longevityToggleBtn');
            const amountToggleBtn = getElem('amountToggleBtn');
            const longevityInputs = getElem('longevityInputs');
            const amountInputs = getElem('amountInputs');
            const increasingToggle = getElem('increasingToggle');
            const withdrawalAmountInput = getElem('withdrawalAmount');
            const sustainedYearsInput = getElem('sustainedYears');
            const incomeFrequencySelect = getElem('incomeFrequency');

            const resultBox = getElem('resultBox');
            const corpusResult = getElem('corpusResult');
            const incomeSection = getElem('incomeSection');
            const incomeResult = getElem('incomeResult');
            const resetBtn = getElem('resetBtn');

            let isLumpsumMode = true;
            let isSipMode = false;
            let isFdMode = false;
            let futureValue = 0;
            let withdrawalMode = 'longevity'; // 'longevity' or 'amount'
            let corpusChart;
            let corpusBreakdownChart;
            let withdrawalChart;

            const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).format(amount);

            // Function to sync input and slider
            const syncInputs = (input, slider) => {
                const updateSliderFill = () => {
                    const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
                    slider.style.setProperty('--fill-percentage', `${percentage}%`);
                };

                input.addEventListener('input', (e) => {
                    slider.value = e.target.value;
                    updateSliderFill();
                });
                slider.addEventListener('input', (e) => {
                    input.value = e.target.value;
                    updateSliderFill();
                });
                // Initial update
                updateSliderFill();
            };

            syncInputs(mainAmountInput, mainAmountSlider);
            syncInputs(investmentYearsInput, investmentYearsSlider);
            syncInputs(annualRateInput, annualRateSlider);
            syncInputs(inflationRateInput, inflationRateSlider);
            syncInputs(taxRateInput, taxRateSlider);

            // Chart setup
            const setupChart = (data) => {
                const ctx = getElem('corpusChart').getContext('2d');
                if (corpusChart) {
                    corpusChart.destroy();
                }
                corpusChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Nominal Value',
                                data: data.nominal,
                                borderColor: '#E34037',
                                tension: 0.1,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Real Value (Adjusted for Inflation)',
                                data: data.real,
                                borderColor: '#4ade80',
                                tension: 0.1,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years',
                                    color: '#6B7280'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Corpus Value',
                                    color: '#6B7280'
                                },
                                beginAtZero: true,
                                ticks: {
                                    color: '#9ca3af',
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#4B5563'
                                }
                            }
                        }
                    }
                });
            };

            const setupBreakdownChart = (invested, returns) => {
                const ctx = getElem('corpusBreakdownChart').getContext('2d');
                if (corpusBreakdownChart) {
                    corpusBreakdownChart.destroy();
                }
                corpusBreakdownChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Total Investment', 'Net Returns'],
                        datasets: [{
                            data: [invested, returns],
                            backgroundColor: ['#3b82f6', '#22c55e'],
                            borderColor: ['#ffffff', '#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#4B5563',
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const setupWithdrawalChart = (chartData) => {
                const canvas = getElem('withdrawalChart');
                if (!canvas) return; // Prevent error if canvas not found
                const ctx = canvas.getContext('2d');
                if (withdrawalChart) {
                    withdrawalChart.destroy();
                }
                withdrawalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Remaining Corpus',
                            data: chartData.data,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: { display: true, text: 'Years Into Withdrawal' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                title: { display: true, text: 'Corpus Value' },
                                beginAtZero: true,
                                ticks: { color: '#9ca3af', callback: (value) => formatCurrency(value) }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            };

            const toggleMode = (mode) => {
                isLumpsumMode = mode === 'lumpsum';
                isSipMode = mode === 'sip';
                isFdMode = mode === 'fd';

                lumpsumToggleBtn.classList.toggle('active', isLumpsumMode);
                sipToggleBtn.classList.toggle('active', isSipMode);
                fdToggleBtn.classList.toggle('active', isFdMode);

                if (isLumpsumMode) {
                    calculatorTitle.textContent = 'Lump-Sum Investment';
                    mainAmountLabelText.textContent = 'Lump-Sum Amount (₹):';
                    mainAmountTooltip.textContent = 'The total single amount you plan to invest at the beginning.';
                    mainAmountInput.placeholder = 'e.g., 100000';
                    mainAmountSlider.max = "100000000"; // 10 Crore
                    mainAmountInput.max = "100000000";
                    mainAmountInput.value = "100000";
                    mainAmountSlider.value = "100000";
                } else if (isSipMode) {
                    calculatorTitle.textContent = 'SIP to Fixed Income';
                    mainAmountLabelText.textContent = 'Monthly SIP Amount (₹):';
                    mainAmountTooltip.textContent = 'The fixed amount you will invest every month.';
                    mainAmountInput.placeholder = 'e.g., 5000';
                    mainAmountSlider.max = "100000"; // 1 Lakh
                    mainAmountInput.max = "100000";
                    mainAmountInput.value = "5000";
                    mainAmountSlider.value = "5000";
                } else if (isFdMode) {
                    calculatorTitle.textContent = 'Fixed Deposit (FD)';
                    mainAmountLabelText.textContent = 'FD Amount (₹):';
                    mainAmountTooltip.textContent = 'The one-time principal amount you are depositing in the Fixed Deposit.';
                    mainAmountInput.placeholder = 'e.g., 500000';
                    mainAmountSlider.max = "50000000"; // 5 Crore
                    mainAmountInput.max = "50000000";
                    mainAmountInput.value = "500000";
                    mainAmountSlider.value = "500000";
                }
                syncInputs(mainAmountInput, mainAmountSlider);
                resetUI();
            };

            const resetUI = () => {
                resultBox.classList.add('hidden');
                corpusResult.innerHTML = '';
                incomeResult.innerHTML = '';
                if (corpusChart) {
                    corpusChart.destroy();
                }
                if (corpusBreakdownChart) {
                    corpusBreakdownChart.destroy();
                }
                if (withdrawalChart) {
                    withdrawalChart.destroy();
                }
                // Fade and disable Step 2
                incomeSection.classList.add('faded');
                document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                    el.classList.add('disabled-input');
                    el.disabled = true;
                });
                resetBtn.classList.add('hidden');
            };

            const resetAll = () => {
                mainAmountInput.value = mainAmountSlider.defaultValue;
                syncInputs(mainAmountInput, mainAmountSlider);
                investmentYearsInput.value = investmentYearsSlider.defaultValue;
                syncInputs(investmentYearsInput, investmentYearsSlider);
                annualRateInput.value = annualRateSlider.defaultValue;
                syncInputs(annualRateInput, annualRateSlider);
                inflationRateInput.value = inflationRateSlider.defaultValue;
                inflationToggle.checked = false;
                handleInflationToggle();
                syncInputs(inflationRateInput, inflationRateSlider);
                taxRateInput.value = taxRateSlider.defaultValue;
                taxToggle.checked = false;
                handleTaxToggle();
                syncInputs(taxRateInput, taxRateSlider);
                withdrawalAmountInput.value = '';
                sustainedYearsInput.value = '';
                toggleWithdrawalMode('longevity');
                toggleMode('lumpsum');
            };

            lumpsumToggleBtn.addEventListener('click', () => toggleMode('lumpsum'));
            sipToggleBtn.addEventListener('click', () => toggleMode('sip'));
            fdToggleBtn.addEventListener('click', () => toggleMode('fd'));
            resetBtn.addEventListener('click', resetAll);

            // Handle rate buttons
            document.querySelectorAll('.btn-rate').forEach(button => {
                button.addEventListener('click', (e) => {
                    annualRateInput.value = e.target.getAttribute('data-rate');
                    syncInputs(annualRateInput, annualRateSlider);
                });
            });

            // Handle Withdrawal Toggles
            const toggleWithdrawalMode = (mode) => {
                withdrawalMode = mode;
                if (mode === 'longevity') {
                    longevityToggleBtn.classList.add('active');
                    amountToggleBtn.classList.remove('active');
                    longevityInputs.classList.remove('hidden');
                    amountInputs.classList.add('hidden');
                } else {
                    longevityToggleBtn.classList.remove('active');
                    amountToggleBtn.classList.add('active');
                    longevityInputs.classList.add('hidden');
                    amountInputs.classList.remove('hidden');
                }
                incomeResult.innerHTML = ''; // Clear previous results
            }
            longevityToggleBtn.addEventListener('click', () => toggleWithdrawalMode('longevity'));
            amountToggleBtn.addEventListener('click', () => toggleWithdrawalMode('amount'));


            // Handle Inflation Toggle
            const handleInflationToggle = () => {
                if(inflationToggle.checked) {
                    inflationInputsContainer.classList.add('open');
                    inflationRateInput.disabled = false;
                    inflationRateSlider.disabled = false;
                } else {
                    inflationInputsContainer.classList.remove('open');
                    inflationRateInput.disabled = true;
                    inflationRateSlider.disabled = true;
                }
            };
            inflationToggle.addEventListener('change', handleInflationToggle);
            inflationHeader.addEventListener('click', (e) => {
                if (e.target.id === 'inflationToggle' || e.target.classList.contains('toggle-slider')) {
                    return;
                }
                inflationToggle.checked = !inflationToggle.checked;
                handleInflationToggle();
            });

            // Handle Tax Toggle
            const handleTaxToggle = () => {
                if (taxToggle.checked) {
                    taxInputsContainer.classList.add('open');
                    taxRateInput.disabled = false;
                    taxRateSlider.disabled = false;
                } else {
                    taxInputsContainer.classList.remove('open');
                    taxRateInput.disabled = true;
                    taxRateSlider.disabled = true;
                }
            };
            taxToggle.addEventListener('change', handleTaxToggle);
            taxHeader.addEventListener('click', (e) => {
                if (e.target.id === 'taxToggle' || e.target.classList.contains('toggle-slider')) {
                    return;
                }
                taxToggle.checked = !taxToggle.checked;
                handleTaxToggle();
            });

            // Step 1: Calculate the future corpus
            calculateCorpusBtn.addEventListener('click', () => {
                const mainAmount = parseFloat(mainAmountInput.value);
                const investmentYears = parseFloat(investmentYearsInput.value);
                const annualRate = parseFloat(annualRateInput.value) / 100;
                const inflationRate = inflationToggle.checked ? parseFloat(inflationRateInput.value) / 100 || 0 : 0;
                const taxRate = taxToggle.checked ? parseFloat(taxRateInput.value) / 100 || 0 : 0;


                // Input validation
                if (isNaN(mainAmount) || isNaN(investmentYears) || isNaN(annualRate) || mainAmount <= 0 || investmentYears <= 0) {
                    corpusResult.innerHTML = '<p class="text-red-600">Please fill in the main amount, investment years, and annual rate with valid, positive numbers.</p>';
                    resetUI();
                    return;
                }
                
                const monthlyRate = annualRate / 12;
                
                let nominalFutureValue = 0;
                let totalInvested = 0;
                
                if (isLumpsumMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + monthlyRate), investmentYears * 12);
                    totalInvested = mainAmount;
                } else if (isSipMode) {
                    nominalFutureValue = mainAmount * ((Math.pow(1 + monthlyRate, investmentYears * 12) - 1) / monthlyRate) * (1 + monthlyRate);
                    totalInvested = mainAmount * investmentYears * 12;
                } else if (isFdMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + annualRate), investmentYears);
                    totalInvested = mainAmount;
                }

                const totalReturns = nominalFutureValue - totalInvested;
                let taxPaid = 0;
                if (taxToggle.checked) {
                    if (isFdMode) {
                        taxPaid = totalReturns * taxRate;
                    } else {
                        const taxableReturns = Math.max(0, totalReturns - (totalInvested * 0.15));
                        taxPaid = taxableReturns * taxRate;
                    }
                }

                const afterTaxFutureValue = nominalFutureValue - taxPaid;
                const realFutureValue = afterTaxFutureValue / Math.pow((1 + inflationRate), investmentYears);

                let corpusHistoryNominal = [], corpusHistoryReal = [], yearsLabels = [];
                for (let year = 0; year <= investmentYears; year++) {
                    yearsLabels.push(year);
                    let currentNominalCorpus;
                    if (isSipMode) {
                        currentNominalCorpus = mainAmount * ((Math.pow(1 + annualRate/12, year * 12) - 1) / (annualRate/12)) * (1 + annualRate/12);
                    } else if (isFdMode) {
                        currentNominalCorpus = mainAmount * Math.pow((1 + annualRate), year);
                    } else { // Lump-sum
                        currentNominalCorpus = mainAmount * Math.pow((1 + monthlyRate), year * 12);
                    }
                    corpusHistoryNominal.push(currentNominalCorpus);
                    corpusHistoryReal.push(currentNominalCorpus / Math.pow((1 + inflationRate), year));
                }
                
                corpusResult.innerHTML = `
                     <div class="text-center bg-white p-4 rounded-lg border mb-4">
                        <p class="text-base text-gray-600">After ${investmentYears} years, you'll have:</p>
                        <p class="text-4xl font-extrabold text-red-600">${formatCurrency(afterTaxFutureValue)}</p>
                        <p class="text-sm mt-1 text-gray-500">
                             <span class="info-tooltip-container">Today's Value: 
                                <strong class="text-green-700 ml-1">${formatCurrency(realFutureValue)}</strong>
                                <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip-text">This is the purchasing power of your final corpus in today's money, after accounting for inflation.</span>
                             </span>
                        </p>
                    </div>
                    <div class="result-details-grid">
                         <div class="h-64 relative">
                            <canvas id="corpusBreakdownChart"></canvas>
                        </div>
                        <div class="space-y-2">
                             <div class="result-card bg-blue-50 border-blue-200">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25-2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 3V9M3 12V9" /></svg>Total Invested</div>
                                <div class="value">${formatCurrency(totalInvested)}</div>
                            </div>
                             <div class="result-card bg-green-50 border-green-200">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.307a11.95 11.95 0 0 1 5.814-5.519l2.74-1.22m0 0-5.94-2.28m5.94 2.28-2.28 5.941" /></svg>Net Returns</div>
                                <div class="value text-green-600">${formatCurrency(totalReturns)}</div>
                            </div>
                            <div class="result-card bg-red-50 border-red-200">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" /></svg>Taxes Paid</div>
                                <div class="value text-red-600">${formatCurrency(taxPaid)}</div>
                            </div>
                        </div>
                    </div>
                `;

                resultBox.classList.remove('hidden');
                
                incomeSection.classList.remove('faded');
                document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                    el.classList.remove('disabled-input');
                    el.disabled = false;
                });
                
                incomeResult.innerHTML = '';
                futureValue = afterTaxFutureValue;
                setupChart({ labels: yearsLabels, nominal: corpusHistoryNominal, real: corpusHistoryReal });
                setupBreakdownChart(totalInvested, totalReturns);
                resetBtn.classList.remove('hidden');
            });

            // Step 2: Calculate fixed income from corpus
            calculateFixedIncomeBtn.addEventListener('click', () => {
                const annualRate = parseFloat(annualRateInput.value) / 100;
                const inflationRate = inflationToggle.checked ? parseFloat(inflationRateInput.value) / 100 || 0 : 0;
                const withdrawalFrequency = parseFloat(incomeFrequencySelect.value);
                const periodicRate = annualRate / withdrawalFrequency;
                
                let resultHTML = '';
                let chartData = {};

                if (withdrawalMode === 'longevity') {
                    const withdrawalAmount = parseFloat(withdrawalAmountInput.value);
                    const isIncreasing = increasingToggle.checked;

                    if (isNaN(withdrawalAmount) || withdrawalAmount <= 0) {
                        incomeResult.innerHTML = '<p class="error">Please enter a valid withdrawal amount.</p>'; return;
                    }

                    let periods = 0;
                    let currentCorpus = futureValue;
                    const maxSimulationPeriods = 60 * withdrawalFrequency;
                    let corpusHistory = [futureValue];
                    let yearLabels = [0];
                    let currentWithdrawal = withdrawalAmount;

                    while (currentCorpus > 0 && periods < maxSimulationPeriods) {
                        currentCorpus = currentCorpus * (1 + periodicRate);
                        
                        if(isIncreasing && periods > 0 && periods % withdrawalFrequency === 0) {
                           currentWithdrawal *= (1 + inflationRate);
                        }
                        
                        currentCorpus -= currentWithdrawal;
                        periods++;
                        corpusHistory.push(Math.max(0, currentCorpus));
                        yearLabels.push(periods / withdrawalFrequency);
                    }
                    const finalCorpus = Math.max(0, currentCorpus);
                    const years = Math.floor(periods / withdrawalFrequency);
                    const remainingPeriods = periods % withdrawalFrequency;
                    const frequencyText = { 12: 'month(s)', 4: 'quarter(s)', 2: 'half-year(s)', 1: 'year(s)' }[withdrawalFrequency];

                    resultHTML = `
                        <h3 class="font-bold mb-4 text-xl text-left">Your Withdrawal Plan</h3>
                        <div class="grid md:grid-cols-2 gap-4 text-left">
                            <div class="result-card bg-green-50 border-green-200 p-4 flex flex-col justify-center">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 12.75h.008v.008H12v-.008z" /></svg>Your Money Will Last For</div>
                                <div class="value text-3xl text-green-700 mt-2">${periods >= maxSimulationPeriods ? '50+ Years' : `${years} years & ${remainingPeriods} ${frequencyText}`}</div>
                                ${periods >= maxSimulationPeriods ? `<p class="text-sm text-green-600 mt-1">Your money is projected to last indefinitely at this rate.</p>` : ''}
                            </div>
                            <div class="result-card bg-gray-50 border-gray-200 p-4 flex flex-col justify-center">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5zM13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>Remaining Balance</div>
                                <div class="value text-xl mt-1">${formatCurrency(finalCorpus)}</div>
                                <p class="text-xs text-gray-500 mt-1">The projected balance after the withdrawal period.</p>
                            </div>
                        </div>
                    `;
                    chartData = { labels: yearLabels, data: corpusHistory };

                } else if (withdrawalMode === 'amount') {
                    const sustainedYears = parseFloat(sustainedYearsInput.value);
                    if (isNaN(sustainedYears) || sustainedYears <= 0) {
                        incomeResult.innerHTML = '<p class="error">Please enter a valid withdrawal period in years.</p>'; return;
                    }
                    
                    const periods = sustainedYears * withdrawalFrequency;
                    const withdrawalAmount = (periodicRate === 0) ? futureValue / periods : (futureValue * periodicRate) / (1 - Math.pow(1 + periodicRate, -periods));

                    let corpusHistory = [futureValue];
                    let yearLabels = [0];
                    let corpusForChart = futureValue;
                    for (let i = 1; i <= periods; i++) {
                         corpusForChart = corpusForChart * (1 + periodicRate) - withdrawalAmount;
                         corpusHistory.push(Math.max(0, corpusForChart));
                         yearLabels.push(i / withdrawalFrequency);
                    }
                    const finalCorpus = Math.max(0, corpusForChart);
                    const frequencyTextSingular = { 12: 'month', 4: 'quarter', 2: 'half-year', 1: 'year' }[withdrawalFrequency];

                     resultHTML = `
                        <h3 class="font-bold mb-4 text-xl text-left">Your Withdrawal Plan</h3>
                        <div class="grid md:grid-cols-2 gap-4 text-left">
                            <div class="result-card bg-blue-50 border-blue-200 p-4 flex flex-col justify-center">
                                <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" /></svg>You Can Withdraw</div>
                                <div class="value text-3xl text-blue-700 mt-2">${formatCurrency(withdrawalAmount)}</div>
                                <p class="text-sm text-gray-600 mt-1">per ${frequencyTextSingular}, for ${sustainedYears} years.</p>
                            </div>
                            <div class="result-card bg-gray-50 border-gray-200 p-4 flex flex-col justify-center">
                                 <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5zM13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>Remaining Balance</div>
                                 <div class="value text-xl mt-1">${formatCurrency(finalCorpus)}</div>
                                 <p class="text-xs text-gray-500 mt-1">The projected balance after ${sustainedYears} years.</p>
                            </div>
                        </div>
                    `;
                    chartData = { labels: yearLabels, data: corpusHistory };
                }
               
                incomeResult.innerHTML = resultHTML + `
                    <div class="mt-6">
                        <h3 class="font-semibold text-lg text-gray-700 mb-2 text-left">Corpus Depletion Over Time</h3>
                        <div class="w-full h-64 bg-white rounded-lg p-2 border">
                            <canvas id="withdrawalChart"></canvas>
                        </div>
                    </div>`;

                 if (chartData.labels && chartData.data) {
                    setupWithdrawalChart(chartData);
                 }
            });
            
            // Initial state setup
            document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                el.classList.add('disabled-input');
                el.disabled = true;
            });
            handleTaxToggle();
            handleInflationToggle();
        });
    </script>
</body>
</html>
