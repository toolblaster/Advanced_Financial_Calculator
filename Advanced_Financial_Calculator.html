<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .calculator-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 38rem; /* Reverted max-width to a single column design */
            margin: 2rem auto;
            border: 1px solid #e5e7eb;
        }
        .input-card {
            background-color: #f9fafb;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-card:hover {
            border-color: #E34037;
            box-shadow: 0 0 0 1px #FCA5A5;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .input-card input[type="number"], .input-card select {
            border: 1px solid #E34037;
            background-color: white;
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-card input[type="number"]:focus, .input-card select:focus {
            outline: none;
            border-color: #E34037;
            box-shadow: 0 0 0 2px rgba(227, 64, 55, 0.5);
        }
        .btn-primary {
            background-color: #E34037;
            color: white;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #bb2c22;
        }
        .result-box {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            color: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 500;
            text-align: center;
        }
        .faded {
            opacity: 0.4;
            pointer-events: none;
            user-select: none;
        }
        .disabled-input {
            cursor: not-allowed;
            background-color: #e5e7eb;
        }
        .error {
            color: #ef4444;
            font-weight: 500;
        }
        /* Custom slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #E34037 var(--fill-percentage, 0%), #e5e7eb var(--fill-percentage, 0%));
            border-radius: 5px;
            outline: none;
            transition: background 0.2s;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #E34037;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(227, 64, 55, 0.3);
            transition: background 0.2s;
        }
        .pill-toggle-container {
            display: flex;
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: #fecaca;
            border: 1px solid #fca5a5;
        }
        .pill-toggle-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            text-align: center;
            margin: 0 4px;
        }
        .pill-toggle-btn.active {
            background-color: #E34037;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }

        /* Tooltip Styles */
        .info-tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .info-icon {
            cursor: pointer;
            margin-left: 8px;
            color: #9ca3af;
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: 400;
        }
        .info-tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Enhanced Result Display Styles */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .result-card {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .result-card .label {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
         .result-card .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .result-card .icon {
            margin-right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
        }
    </style>
</head>
<body class="p-4">

    <div class="text-center my-4">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Financial Calculator</h1>
        <p class="mt-2 text-lg text-gray-500">Plan your investments and retirement with advanced analysis.</p>
    </div>

    <!-- Unified Calculator -->
    <div class="calculator-card">
        <div class="flex justify-center mb-4">
             <div class="pill-toggle-container">
                <button id="lumpsumToggleBtn" class="pill-toggle-btn active">Lump-Sum</button>
                <button id="sipToggleBtn" class="pill-toggle-btn">SIP</button>
                <button id="fdToggleBtn" class="pill-toggle-btn">FD</button>
            </div>
        </div>

        <h2 id="calculatorTitle" class="text-2xl font-semibold text-gray-800 mb-4 text-center">Lump-Sum Investment</h2>
        
        <div class="flex flex-col gap-4">
            <!-- Top Section: Step 1 Inputs -->
            <div class="space-y-2">
                <h3 class="text-lg font-semibold text-gray-700">Step 1: Grow Your Investment</h3>
                
                <div class="input-card flex flex-col">
                    <label id="mainAmountLabel" for="mainAmountInput" class="mb-1">Lump-Sum Amount (â‚¹):</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="mainAmountSlider" min="1000" max="10000000" step="1000" value="100000" class="flex-1">
                        <input type="number" id="mainAmountInput" placeholder="e.g., 100000" class="w-2/5" value="100000">
                    </div>
                </div>

                <div class="input-card flex flex-col">
                    <label for="investmentYearsInput" class="mb-1">Investment Period (Years):</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="investmentYearsSlider" min="1" max="50" step="1" value="10" class="flex-1">
                        <input type="number" id="investmentYearsInput" placeholder="e.g., 10" class="w-2/5" value="10">
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <label for="annualRateInput" class="mb-1 info-tooltip-container">Expected Annual Return (%)
                        <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span class="tooltip-text">This is the average return you expect from your investment each year. Equity funds average 12-15%, while FDs are around 6-7%.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="annualRateSlider" min="1" max="30" step="0.1" value="12" class="flex-1">
                        <input type="number" id="annualRateInput" placeholder="e.g., 12" class="w-2/5" value="12">
                    </div>
                    <div class="flex justify-between mt-2 space-x-2">
                        <button data-rate="14" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Equity (14%)</button>
                        <button data-rate="10" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Hybrid (10%)</button>
                        <button data-rate="7" class="btn-rate btn-primary flex-1 text-xs sm:text-base">Debt (7%)</button>
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <label for="inflationRateInput" class="mb-1 info-tooltip-container">Expected Annual Inflation (%)
                        <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span class="tooltip-text">Inflation is the rate at which prices for goods and services rise, reducing the purchasing power of your money. India's long-term average is around 6%.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="inflationRateSlider" min="0" max="15" step="0.1" value="6" class="flex-1">
                        <input type="number" id="inflationRateInput" placeholder="e.g., 6" class="w-2/5" value="6">
                    </div>
                </div>

                <div class="input-card flex flex-col">
                     <label for="taxRateInput" class="mb-1 info-tooltip-container">Tax Rate (%)
                        <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                        <span class="tooltip-text">The tax applied to your investment gains. For FDs, it's as per your income slab. For stocks/mutual funds, long-term capital gains tax is typically 10%.</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="taxRateSlider" min="0" max="50" step="1" value="10" class="flex-1">
                        <input type="number" id="taxRateInput" placeholder="e.g., 10" class="w-2/5" value="10">
                    </div>
                </div>
                <button id="calculateCorpusBtn" class="btn-primary w-full mt-4">Calculate Corpus</button>
            </div>

            <!-- Bottom Section: Results and Step 2 Inputs -->
            <div class="space-y-2">
                 <div id="resultBox" class="result-box hidden">
                    <!-- Step 1 Result -->
                    <div id="corpusResult" class="mb-4 text-gray-800"></div>
                    
                    <!-- Chart Container -->
                    <div class="w-full mb-6">
                        <canvas id="corpusChart"></canvas>
                    </div>

                    <!-- Step 2 Inputs (Faded by default) -->
                    <div id="incomeSection" class="faded">
                        <hr class="my-4 border-gray-300">
                        <h3 class="text-lg font-semibold text-gray-700">Step 2: Plan Your Withdrawals</h3>
                        <div class="space-y-2 mt-4">
                            <div class="input-card flex flex-col mb-4">
                                <label for="withdrawalStrategy" class="mb-1">Withdrawal Strategy:</label>
                                <select id="withdrawalStrategy" class="w-full disabled-input">
                                    <option value="fixed">Fixed Withdrawal</option>
                                    <option value="increasing">Increasing Withdrawal (with Inflation)</option>
                                    <option value="sustained">Sustained Withdrawal (for X years)</option>
                                </select>
                            </div>

                            <div id="fixedWithdrawalGroup" class="input-card flex flex-col mb-4">
                                <label for="withdrawalAmount" class="mb-1">How much to withdraw?</label>
                                <input type="number" id="withdrawalAmount" placeholder="e.g., 50000" class="w-full disabled-input">
                            </div>

                            <div id="sustainedYearsGroup" class="input-card flex-col mb-4 hidden">
                                <label for="sustainedYears" class="mb-1">Withdrawal Period (Years):</label>
                                <input type="number" id="sustainedYears" placeholder="e.g., 20" class="w-full disabled-input">
                            </div>

                            <div class="input-card flex flex-col mb-4">
                                <label for="incomeFrequency" class="mb-1">Withdrawal Frequency:</label>
                                <select id="incomeFrequency" class="w-full disabled-input">
                                    <option value="12">Monthly</option>
                                    <option value="4">Quarterly</option>
                                    <option value="2">Half-Yearly</option>
                                    <option value="1">Yearly</option>
                                </select>
                            </div>

                            <button id="calculateFixedIncomeBtn" class="btn-primary w-full disabled-input">How Long Will It Last?</button>
                            <div id="incomeResult" class="mt-4 text-gray-800"></div>
                        </div>
                    </div>
                </div>
                <button id="resetBtn" class="btn-primary w-full mt-4 hidden">Reset Calculator</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getElem = (id) => document.getElementById(id);
            const lumpsumToggleBtn = getElem('lumpsumToggleBtn');
            const sipToggleBtn = getElem('sipToggleBtn');
            const fdToggleBtn = getElem('fdToggleBtn');
            const calculatorTitle = getElem('calculatorTitle');
            const mainAmountLabel = getElem('mainAmountLabel');
            const mainAmountInput = getElem('mainAmountInput');
            const mainAmountSlider = getElem('mainAmountSlider');
            const investmentYearsInput = getElem('investmentYearsInput');
            const investmentYearsSlider = getElem('investmentYearsSlider');
            const annualRateInput = getElem('annualRateInput');
            const annualRateSlider = getElem('annualRateSlider');
            const inflationRateInput = getElem('inflationRateInput');
            const inflationRateSlider = getElem('inflationRateSlider');
            const taxRateInput = getElem('taxRateInput');
            const taxRateSlider = getElem('taxRateSlider');
            const calculateCorpusBtn = getElem('calculateCorpusBtn');
            const calculateFixedIncomeBtn = getElem('calculateFixedIncomeBtn');
            const withdrawalStrategySelect = getElem('withdrawalStrategy');
            const fixedWithdrawalGroup = getElem('fixedWithdrawalGroup');
            const sustainedYearsGroup = getElem('sustainedYearsGroup');
            const withdrawalAmountInput = getElem('withdrawalAmount');
            const sustainedYearsInput = getElem('sustainedYears');
            const incomeFrequencySelect = getElem('incomeFrequency');
            const resultBox = getElem('resultBox');
            const corpusResult = getElem('corpusResult');
            const incomeSection = getElem('incomeSection');
            const incomeResult = getElem('incomeResult');
            const resetBtn = getElem('resetBtn');

            let isLumpsumMode = true;
            let isSipMode = false;
            let isFdMode = false;
            let futureValue = 0;
            let corpusChart;

            const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).format(amount);

            // Function to sync input and slider
            const syncInputs = (input, slider) => {
                const updateSliderFill = () => {
                    const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
                    slider.style.setProperty('--fill-percentage', `${percentage}%`);
                };

                input.addEventListener('input', (e) => {
                    slider.value = e.target.value;
                    updateSliderFill();
                });
                slider.addEventListener('input', (e) => {
                    input.value = e.target.value;
                    updateSliderFill();
                });
                // Initial update
                updateSliderFill();
            };

            syncInputs(mainAmountInput, mainAmountSlider);
            syncInputs(investmentYearsInput, investmentYearsSlider);
            syncInputs(annualRateInput, annualRateSlider);
            syncInputs(inflationRateInput, inflationRateSlider);
            syncInputs(taxRateInput, taxRateSlider);

            // Chart setup
            const setupChart = (data) => {
                const ctx = getElem('corpusChart').getContext('2d');
                if (corpusChart) {
                    corpusChart.destroy();
                }
                corpusChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Nominal Value',
                                data: data.nominal,
                                borderColor: '#E34037',
                                tension: 0.1,
                                fill: false,
                                pointRadius: 0
                            },
                            {
                                label: 'Real Value (Adjusted for Inflation)',
                                data: data.real,
                                borderColor: '#4ade80',
                                tension: 0.1,
                                fill: false,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years',
                                    color: '#6B7280'
                                },
                                ticks: {
                                    color: '#9ca3af'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Corpus Value',
                                    color: '#6B7280'
                                },
                                beginAtZero: true,
                                ticks: {
                                    color: '#9ca3af',
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#4B5563'
                                }
                            }
                        }
                    }
                });
            };

            const toggleMode = (mode) => {
                isLumpsumMode = mode === 'lumpsum';
                isSipMode = mode === 'sip';
                isFdMode = mode === 'fd';

                lumpsumToggleBtn.classList.toggle('active', isLumpsumMode);
                sipToggleBtn.classList.toggle('active', isSipMode);
                fdToggleBtn.classList.toggle('active', isFdMode);

                calculatorTitle.textContent = isLumpsumMode ? 'Lump-Sum Investment' : isSipMode ? 'SIP to Fixed Income' : 'Fixed Deposit (FD)';
                mainAmountLabel.textContent = isSipMode ? 'Monthly SIP Amount (â‚¹):' : 'Lump-Sum Amount (â‚¹):';
                mainAmountInput.placeholder = isSipMode ? 'e.g., 5000' : 'e.g., 100000';
                
                resetUI();
            };

            const resetUI = () => {
                resultBox.classList.add('hidden');
                corpusResult.innerHTML = '';
                incomeResult.innerHTML = '';
                if (corpusChart) {
                    corpusChart.destroy();
                }
                // Fade and disable Step 2
                incomeSection.classList.add('faded');
                document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                    el.classList.add('disabled-input');
                    el.disabled = true;
                });
                resetBtn.classList.add('hidden');
            };

            const resetAll = () => {
                mainAmountInput.value = mainAmountSlider.defaultValue;
                syncInputs(mainAmountInput, mainAmountSlider);
                investmentYearsInput.value = investmentYearsSlider.defaultValue;
                syncInputs(investmentYearsInput, investmentYearsSlider);
                annualRateInput.value = annualRateSlider.defaultValue;
                syncInputs(annualRateInput, annualRateSlider);
                inflationRateInput.value = inflationRateSlider.defaultValue;
                syncInputs(inflationRateInput, inflationRateSlider);
                taxRateInput.value = taxRateSlider.defaultValue;
                syncInputs(taxRateInput, taxRateSlider);
                withdrawalAmountInput.value = '';
                sustainedYearsInput.value = '';
                withdrawalStrategySelect.value = 'fixed';
                fixedWithdrawalGroup.classList.remove('hidden');
                sustainedYearsGroup.classList.add('hidden');
                toggleMode('lumpsum');
            };

            lumpsumToggleBtn.addEventListener('click', () => toggleMode('lumpsum'));
            sipToggleBtn.addEventListener('click', () => toggleMode('sip'));
            fdToggleBtn.addEventListener('click', () => toggleMode('fd'));
            resetBtn.addEventListener('click', resetAll);

            // Handle rate buttons
            document.querySelectorAll('.btn-rate').forEach(button => {
                button.addEventListener('click', (e) => {
                    annualRateInput.value = e.target.getAttribute('data-rate');
                    syncInputs(annualRateInput, annualRateSlider);
                });
            });

            // Handle withdrawal strategy change
            withdrawalStrategySelect.addEventListener('change', (e) => {
                const strategy = e.target.value;
                if (strategy === 'sustained') {
                    fixedWithdrawalGroup.classList.add('hidden');
                    sustainedYearsGroup.classList.remove('hidden');
                    sustainedYearsGroup.classList.add('flex');
                } else {
                    fixedWithdrawalGroup.classList.remove('hidden');
                    sustainedYearsGroup.classList.add('hidden');
                }
            });

            // Step 1: Calculate the future corpus
            calculateCorpusBtn.addEventListener('click', () => {
                const mainAmount = parseFloat(mainAmountInput.value);
                const investmentYears = parseFloat(investmentYearsInput.value);
                const annualRate = parseFloat(annualRateInput.value) / 100;
                const inflationRate = parseFloat(inflationRateInput.value) / 100 || 0;
                const taxRate = parseFloat(taxRateInput.value) / 100 || 0;

                // Input validation
                if (isNaN(mainAmount) || isNaN(investmentYears) || isNaN(annualRate) || mainAmount <= 0 || investmentYears <= 0) {
                    corpusResult.innerHTML = '<p class="text-red-600">Please fill in the main amount, investment years, and annual rate with valid, positive numbers.</p>';
                    resetUI();
                    return;
                }
                
                const monthlyRate = annualRate / 12;
                
                let nominalFutureValue = 0;
                let totalInvested = 0;
                
                if (isLumpsumMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + monthlyRate), investmentYears * 12);
                    totalInvested = mainAmount;
                } else if (isSipMode) {
                    nominalFutureValue = mainAmount * ((Math.pow(1 + monthlyRate, investmentYears * 12) - 1) / monthlyRate) * (1 + monthlyRate);
                    totalInvested = mainAmount * investmentYears * 12;
                } else if (isFdMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + annualRate), investmentYears);
                    totalInvested = mainAmount;
                }

                const totalReturns = nominalFutureValue - totalInvested;
                let taxPaid = 0;
                if (isFdMode) {
                    taxPaid = totalReturns * taxRate;
                } else {
                    const taxableReturns = Math.max(0, totalReturns - (totalInvested * 0.15));
                    taxPaid = taxableReturns * taxRate;
                }

                const afterTaxFutureValue = nominalFutureValue - taxPaid;
                const realFutureValue = afterTaxFutureValue / Math.pow((1 + inflationRate), investmentYears);

                let corpusHistoryNominal = [], corpusHistoryReal = [], yearsLabels = [];
                for (let year = 0; year <= investmentYears; year++) {
                    yearsLabels.push(year);
                    let currentNominalCorpus;
                    if (isSipMode) {
                        currentNominalCorpus = mainAmount * ((Math.pow(1 + annualRate/12, year * 12) - 1) / (annualRate/12)) * (1 + annualRate/12);
                    } else if (isFdMode) {
                        currentNominalCorpus = mainAmount * Math.pow((1 + annualRate), year);
                    } else { // Lump-sum
                        currentNominalCorpus = mainAmount * Math.pow((1 + annualRate), year);
                    }
                    corpusHistoryNominal.push(currentNominalCorpus);
                    corpusHistoryReal.push(currentNominalCorpus / Math.pow((1 + inflationRate), year));
                }
                
                corpusResult.innerHTML = `
                    <h3 class="font-bold mb-4 text-xl text-left">After ${investmentYears} years, you'll have:</h3>
                    <div class="result-grid">
                        <div class="result-card">
                            <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M7.5 12l.879.659c1.171.879 3.07.879 4.242 0l.879-.659M12 18.75h.008v.008H12v-.008z" /></svg>Total Invested</div>
                            <div class="value">${formatCurrency(totalInvested)}</div>
                        </div>
                         <div class="result-card">
                            <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /></svg>Wealth Gained</div>
                            <div class="value text-green-600">${formatCurrency(totalReturns)}</div>
                        </div>
                        <div class="result-card">
                            <div class="label"><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 100 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Taxes Paid</div>
                            <div class="value text-red-600">${formatCurrency(taxPaid)}</div>
                        </div>
                    </div>
                    <div class="text-center bg-white p-4 rounded-lg border">
                        <p class="text-sm text-gray-600">Final Corpus (Post-Tax)</p>
                        <p class="text-3xl font-bold text-red-600">${formatCurrency(afterTaxFutureValue)}</p>
                        <p class="text-sm mt-1 text-gray-500">
                             <span class="info-tooltip-container">Today's Value: 
                                <strong class="text-green-700 ml-1">${formatCurrency(realFutureValue)}</strong>
                                <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                <span class="tooltip-text">This is the purchasing power of your final corpus in today's money, after accounting for inflation.</span>
                             </span>
                        </p>
                    </div>
                `;

                resultBox.classList.remove('hidden');
                
                incomeSection.classList.remove('faded');
                document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                    el.classList.remove('disabled-input');
                    el.disabled = false;
                });
                
                incomeResult.innerHTML = '';
                futureValue = afterTaxFutureValue;
                setupChart({ labels: yearsLabels, nominal: corpusHistoryNominal, real: corpusHistoryReal });
                resetBtn.classList.remove('hidden');
            });

            // Step 2: Calculate fixed income from corpus
            calculateFixedIncomeBtn.addEventListener('click', () => {
                const annualRate = parseFloat(annualRateInput.value) / 100;
                const inflationRate = parseFloat(inflationRateInput.value) / 100 || 0;
                const withdrawalFrequency = parseFloat(incomeFrequencySelect.value);
                const periodicRate = annualRate / withdrawalFrequency;
                const periodicInflationRate = inflationRate / withdrawalFrequency;
                const strategy = withdrawalStrategySelect.value;
                
                let withdrawalAmount = parseFloat(withdrawalAmountInput.value);
                let sustainedYears = parseFloat(sustainedYearsInput.value);

                let periods;
                let finalCorpus = 0;
                let currentCorpus = futureValue;
                const maxSimulationPeriods = 50 * withdrawalFrequency;

                if (strategy === 'fixed') {
                    if (isNaN(withdrawalAmount) || withdrawalAmount <= 0) {
                        incomeResult.innerHTML = '<p class="error">Please enter a valid withdrawal amount.</p>'; return;
                    }
                    periods = 0;
                    while (currentCorpus > 0 && periods < maxSimulationPeriods) {
                        currentCorpus = currentCorpus * (1 + periodicRate) - withdrawalAmount;
                        periods++;
                    }
                    finalCorpus = Math.max(0, currentCorpus);
                } else if (strategy === 'increasing') {
                    if (isNaN(withdrawalAmount) || withdrawalAmount <= 0) {
                        incomeResult.innerHTML = '<p class="error">Please enter a valid initial withdrawal amount.</p>'; return;
                    }
                    periods = 0;
                    let currentWithdrawal = withdrawalAmount;
                    while (currentCorpus > 0 && periods < maxSimulationPeriods) {
                        currentCorpus = currentCorpus * (1 + periodicRate) - currentWithdrawal;
                        periods++;
                        if (periods % withdrawalFrequency === 0) {
                            currentWithdrawal *= (1 + inflationRate);
                        }
                    }
                    finalCorpus = Math.max(0, currentCorpus);
                } else if (strategy === 'sustained') {
                    if (isNaN(sustainedYears) || sustainedYears <= 0) {
                        incomeResult.innerHTML = '<p class="error">Please enter a valid withdrawal period in years.</p>'; return;
                    }
                    periods = sustainedYears * withdrawalFrequency;
                    withdrawalAmount = (periodicRate === 0) ? futureValue / periods : (futureValue * periodicRate) / (1 - Math.pow(1 + periodicRate, -periods));
                    let nominalCorpus = futureValue;
                    for (let i = 0; i < periods; i++) {
                        nominalCorpus = nominalCorpus * (1 + periodicRate) - withdrawalAmount;
                    }
                    finalCorpus = Math.max(0, nominalCorpus);
                }
                
                const years = Math.floor(periods / withdrawalFrequency);
                const remainingPeriods = periods % withdrawalFrequency;
                const frequencyText = { 12: 'month(s)', 4: 'quarter(s)', 2: 'half-year(s)', 1: 'year(s)' }[withdrawalFrequency];

                incomeResult.innerHTML = `
                    <h3 class="font-bold mb-2 text-xl">How Long Your Money Will Last</h3>
                    ${strategy === 'sustained' ? 
                        `<p class="text-sm">To make your money last for ${sustainedYears} years, you can withdraw:</p>
                         <p class="text-2xl font-bold text-green-700">${formatCurrency(withdrawalAmount)} per period</p>` :
                        `<p class="text-sm">Your savings can provide ${formatCurrency(withdrawalAmount)} for:</p>
                         <p class="text-2xl font-bold text-green-700">${years} years and ${remainingPeriods} ${frequencyText}</p>`
                    }
                    ${periods >= maxSimulationPeriods ? `<p class="text-green-600 mt-2">Based on this withdrawal rate, your money is projected to last indefinitely.</p>` : ''}
                    <p class="mt-4 text-sm">Remaining balance after this period: <span class="text-lg font-bold">${formatCurrency(finalCorpus)}</span></p>
                `;
            });
            
            // Initial state setup
            document.querySelectorAll('#incomeSection input, #incomeSection select, #incomeSection button').forEach(el => {
                el.classList.add('disabled-input');
                el.disabled = true;
            });
        });
    </script>
</body>
</html>
