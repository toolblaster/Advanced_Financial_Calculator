<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .calculator-card {
            background-color: white;
            padding: 1rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 1000px; /* Re-constrained width for stability */
            margin: 2rem auto;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 1024px) {
            .calculator-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 2rem;
            }
        }
        .input-card {
            background-color: #f9fafb;
            padding: 0.625rem; /* Reduced padding */
            border-radius: 0.75rem;
            border: 1px solid #f87171; /* Red border applied */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-card:focus-within {
            border-color: #E34037;
            box-shadow: 0 0 0 1px #FCA5A5;
        }
        .input-group label {
            font-weight: 500;
            color: #4b5563;
        }
        .input-card input[type="number"], .input-card select {
            border: 1px solid #d1d5db;
            background-color: white;
            color: #1f2937;
            border-radius: 0.5rem;
            padding: 0.4rem 0.5rem; /* Reduced padding */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-card input[type="number"]:focus, .input-card select:focus {
            outline: none;
            border-color: #E34037;
            box-shadow: 0 0 0 2px rgba(227, 64, 55, 0.5);
        }
        .btn-primary {
            background-color: #E34037;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #bb2c22;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .btn-secondary {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .btn-secondary:hover {
            background-color: #fecaca; /* red-200 */
        }
        /* Results Section Styling */
        .results-column {
            background-color: #f9fafb;
            border-radius: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            min-height: 500px;
        }
        .results-column.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .faded {
            opacity: 0.4;
            pointer-events: none;
            user-select: none;
        }
        /* Alert/Warning Box for Edge Cases */
        .alert-box {
            display: flex;
            align-items: start;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .alert-warning {
            background-color: #fefce8; /* yellow-50 */
            color: #a16207; /* yellow-700 */
            border: 1px solid #fef08a; /* yellow-200 */
        }
        .alert-info {
            background-color: #eff6ff; /* blue-50 */
            color: #1d4ed8; /* blue-700 */
            border: 1px solid #bfdbfe; /* blue-200 */
        }
        .alert-box svg {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
        }
        /* Custom slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #E34037 var(--fill-percentage, 0%), #e5e7eb var(--fill-percentage, 0%));
            border-radius: 5px;
            outline: none;
            transition: background 0.2s;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #E34037;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(227, 64, 55, 0.3);
            transition: background 0.2s;
        }
        .pill-toggle-container {
            display: flex;
            padding: 0.25rem;
            border-radius: 9999px;
            background-color: #fecaca;
            border: 1px solid #fca5a5;
        }
        .pill-toggle-btn {
            padding: 0.25rem 0.75rem; /* Reduced padding */
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 9999px;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
            text-align: center;
        }
        .pill-toggle-btn.active {
            background-color: #E34037;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
        }
        .info-tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .info-icon {
            cursor: pointer;
            flex-shrink: 0;
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            font-weight: 400;
            pointer-events: none;
        }
        .info-tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .result-card {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .result-card .label {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
         .result-card .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .result-card .icon {
            margin-right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #E34037; }
        input:checked + .toggle-slider:before { transform: translateX(26px); }
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible.open { max-height: 100px; }
        .header-area {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 1.5rem 1rem; /* Reduced padding */
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        .yearly-breakdown-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-screen-xl mx-auto bg-emerald-50 p-4 sm:p-6 md:p-8 rounded-3xl border border-emerald-200">

        <div class="header-area text-center">
            <div class="flex items-center justify-center mb-2">
                <svg class="w-8 h-8 text-red-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                </svg>
                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800">Horizon Financial Planner</h1>
            </div>
            <p class="mt-1 text-base text-gray-500">A dynamic tool for investment growth and retirement income planning.</p>
        </div>

        <div class="calculator-card">
            <div class="calculator-grid">
                <!-- Left Column: Inputs -->
                <div class="input-column">
                    <div class="flex justify-center mb-4">
                         <div class="pill-toggle-container">
                            <button id="lumpsumToggleBtn" class="pill-toggle-btn active">Lump-Sum</button>
                            <button id="sipToggleBtn" class="pill-toggle-btn">SIP</button>
                            <button id="fdToggleBtn" class="pill-toggle-btn">FD</button>
                        </div>
                    </div>
                     <h2 id="calculatorTitle" class="text-2xl font-semibold text-gray-800 mb-4 text-center">Lump-Sum Investment</h2>
                    
                    <div class="flex flex-col gap-3">
                        <div class="space-y-2">
                            <div class="input-card flex flex-col">
                                <label id="mainAmountLabel" for="mainAmountInput" class="mb-1 info-tooltip-container">
                                    <span id="mainAmountLabelText">Lump-Sum Amount (₹):</span>
                                    <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                    <span id="mainAmountTooltip" class="tooltip-text">The total single amount you plan to invest at the beginning.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="mainAmountSlider" min="1000" max="10000000" step="1000" value="100000" class="flex-1">
                                    <input type="number" id="mainAmountInput" placeholder="e.g., 100000" class="w-2/5" value="100000" min="1000" max="10000000">
                                </div>
                            </div>
                            <div class="input-card flex flex-col">
                                <label for="investmentYearsInput" class="mb-1 info-tooltip-container">Investment Period (Years):
                                    <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                    <span class="tooltip-text">The total number of years you plan to keep your money invested to let it grow.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="investmentYearsSlider" min="1" max="50" step="1" value="10" class="flex-1">
                                    <input type="number" id="investmentYearsInput" placeholder="e.g., 10" class="w-2/5" value="10" min="1" max="50">
                                </div>
                            </div>
                            <div class="input-card flex flex-col">
                                 <label for="annualRateInput" class="mb-1 info-tooltip-container">Expected Annual Return (%)
                                    <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                    <span class="tooltip-text">This is the average return you expect from your investment each year. Equity funds average 12-15%, while FDs are around 6-7%.</span>
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input type="range" id="annualRateSlider" min="1" max="30" step="0.1" value="12" class="flex-1">
                                    <input type="number" id="annualRateInput" placeholder="e.g., 12" class="w-2/5" value="12" min="1" max="30">
                                </div>
                                <div class="flex justify-between mt-2 space-x-2">
                                    <button data-rate="14" class="btn-rate btn-secondary flex-1">Equity (14%)</button>
                                    <button data-rate="10" class="btn-rate btn-secondary flex-1">Hybrid (10%)</button>
                                    <button data-rate="7" class="btn-rate btn-secondary flex-1">Debt (7%)</button>
                                </div>
                            </div>
                            <div class="input-card flex flex-col">
                                 <div class="flex justify-between items-center cursor-pointer" id="inflationHeader">
                                    <label for="inflationRateInput" class="info-tooltip-container">Expected Annual Inflation (%)
                                        <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                        <span class="tooltip-text">Inflation is the rate at which prices for goods and services rise, reducing the purchasing power of your money. India's long-term average is around 6%.</span>
                                    </label>
                                    <label class="toggle-switch"><input type="checkbox" id="inflationToggle"><span class="toggle-slider"></span></label>
                                 </div>
                                <div id="inflationInputsContainer" class="collapsible">
                                    <div class="flex items-center space-x-2 pt-2 mt-2 border-t">
                                        <input type="range" id="inflationRateSlider" min="0" max="15" step="0.1" value="6" class="flex-1">
                                        <input type="number" id="inflationRateInput" placeholder="e.g., 6" class="w-2/5" value="6" min="0" max="15">
                                    </div>
                                </div>
                            </div>
                            <div class="input-card flex flex-col">
                                 <div class="flex justify-between items-center cursor-pointer" id="taxHeader">
                                    <label for="taxRateInput" class="info-tooltip-container">Tax Rate (%)
                                        <svg class="info-icon ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.055.491.223.57.45l.082.38-.45.083a.502.502 0 0 0-.423.49l-.022.46-.364.073.022.46c.015.322.21.61.506.758.296.148.64.21.99.21.35 0 .694-.062.99-.21.296-.148.49-.436.506-.758l.022-.46-.364-.073-.022-.46a.502.502 0 0 0-.423-.49l-.45-.083.082-.38c.078-.227.276-.395.57-.45l.45-.083-.082-.38-.29-.287zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                        <span class="tooltip-text">The tax applied to your investment gains. For FDs, it's as per your income slab. For stocks/mutual funds, long-term capital gains tax is typically 10%.</span>
                                    </label>
                                    <label class="toggle-switch"><input type="checkbox" id="taxToggle"><span class="toggle-slider"></span></label>
                                </div>
                                <div id="taxInputsContainer" class="collapsible">
                                    <div class="flex items-center space-x-2 pt-2 mt-2 border-t">
                                        <input type="range" id="taxRateSlider" min="0" max="50" step="1" value="10" class="flex-1">
                                        <input type="number" id="taxRateInput" placeholder="e.g., 10" class="w-2/5" value="10" min="0" max="50">
                                    </div>
                                </div>
                            </div>
                             <div id="step1-error" class="text-red-600 text-sm mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Results -->
                <div id="resultsColumn" class="results-column">
                    <div id="resultsPlaceholder">
                        <div class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                            <svg class="w-16 h-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm3-6h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zM12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18z" /></svg>
                            <h3 class="text-xl font-semibold">Your Results Will Appear Here</h3>
                            <p class="mt-2">Adjust the values on the left to see your financial future in real-time.</p>
                        </div>
                    </div>
                    <div id="resultsContent" class="hidden">
                         <!-- Corpus Results -->
                        <div id="corpusResult" class="mb-4 text-gray-800"></div>
                        <div class="w-full mb-6"><canvas id="corpusChart"></canvas></div>

                        <!-- Withdrawal Section -->
                        <div id="incomeSection" class="mt-6">
                            <hr class="my-4 border-gray-300">
                            <h3 class="text-lg font-semibold text-gray-700">Step 2: Plan Your Withdrawals</h3>
                            <div class="flex justify-center my-4">
                                <div class="pill-toggle-container">
                                   <div class="info-tooltip-container mx-1">
                                       <button id="longevityToggleBtn" class="pill-toggle-btn active flex items-center justify-center">Longevity</button>
                                       <span class="tooltip-text">Calculates how many years your corpus will last if you withdraw a fixed amount regularly.</span>
                                   </div>
                                   <div class="info-tooltip-container mx-1">
                                       <button id="amountToggleBtn" class="pill-toggle-btn flex items-center justify-center">Withdrawal</button>
                                       <span class="tooltip-text">Calculates the maximum amount you can withdraw regularly for a fixed number of years.</span>
                                   </div>
                               </div>
                           </div>

                            <div class="space-y-2 mt-4">
                                <div id="longevityInputs">
                                    <div class="input-card flex flex-col mb-4">
                                        <label for="withdrawalAmount" class="mb-1">Desired Withdrawal Amount:</label>
                                        <input type="number" id="withdrawalAmount" placeholder="e.g., 50000" class="w-full" min="0">
                                    </div>
                                    <div class="input-card flex items-center justify-between mb-4 p-3">
                                         <label for="increasingToggle" class="mb-0">Increase withdrawals with inflation?</label>
                                         <label class="toggle-switch"><input type="checkbox" id="increasingToggle"><span class="toggle-slider"></span></label>
                                    </div>
                                </div>
                                <div id="amountInputs" class="hidden">
                                    <div class="input-card flex flex-col mb-4">
                                        <label for="sustainedYears" class="mb-1">Withdraw For How Many Years?</label>
                                        <input type="number" id="sustainedYears" placeholder="e.g., 20" class="w-full" min="1">
                                    </div>
                                </div>
                                <div class="input-card flex flex-col mb-4">
                                    <label for="incomeFrequency" class="mb-1">Withdrawal Frequency:</label>
                                    <select id="incomeFrequency" class="w-full">
                                        <option value="12">Monthly</option>
                                        <option value="4">Quarterly</option>
                                        <option value="2">Half-Yearly</option>
                                        <option value="1">Yearly</option>
                                    </select>
                                </div>
                                <div id="edge-case-alerts" class="mt-4"></div>
                                <div id="incomeResult" class="mt-4 text-gray-800"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="flex justify-center mt-4">
                <button id="resetBtn" class="btn-primary mt-4 px-12">Reset Calculator</button>
            </div>
        </div>

        <!-- Yearly Breakdown Section -->
        <div id="yearlyBreakdown" class="calculator-card mt-6 hidden bg-rose-50 border-rose-200">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Yearly Growth Breakdown</h3>
            <div class="yearly-breakdown-container">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-200 sticky top-0">
                        <tr>
                            <th scope="col" class="px-4 py-3">Year</th>
                            <th scope="col" class="px-4 py-3">Invested</th>
                            <th scope="col" class="px-4 py-3">Interest</th>
                            <th scope="col" class="px-4 py-3">End Value</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyBreakdownBody">
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const getElem = (id) => document.getElementById(id);
            const lumpsumToggleBtn = getElem('lumpsumToggleBtn');
            const sipToggleBtn = getElem('sipToggleBtn');
            const fdToggleBtn = getElem('fdToggleBtn');
            const calculatorTitle = getElem('calculatorTitle');
            const mainAmountLabelText = getElem('mainAmountLabelText');
            const mainAmountTooltip = getElem('mainAmountTooltip');
            const mainAmountInput = getElem('mainAmountInput');
            const mainAmountSlider = getElem('mainAmountSlider');
            const investmentYearsInput = getElem('investmentYearsInput');
            const investmentYearsSlider = getElem('investmentYearsSlider');
            const annualRateInput = getElem('annualRateInput');
            const annualRateSlider = getElem('annualRateSlider');
            const inflationRateInput = getElem('inflationRateInput');
            const inflationRateSlider = getElem('inflationRateSlider');
            const inflationToggle = getElem('inflationToggle');
            const inflationInputsContainer = getElem('inflationInputsContainer');
            const inflationHeader = getElem('inflationHeader');
            const taxRateInput = getElem('taxRateInput');
            const taxRateSlider = getElem('taxRateSlider');
            const taxToggle = getElem('taxToggle');
            const taxInputsContainer = getElem('taxInputsContainer');
            const taxHeader = getElem('taxHeader');
            const step1Error = getElem('step1-error');
            const yearlyBreakdown = getElem('yearlyBreakdown');
            const yearlyBreakdownBody = getElem('yearlyBreakdownBody');
            
            // Results & Withdrawal Section Elements
            const resultsColumn = getElem('resultsColumn');
            const resultsPlaceholder = getElem('resultsPlaceholder');
            const resultsContent = getElem('resultsContent');
            const corpusResult = getElem('corpusResult');
            const incomeSection = getElem('incomeSection');
            const incomeResult = getElem('incomeResult');
            const edgeCaseAlerts = getElem('edge-case-alerts');
            const longevityToggleBtn = getElem('longevityToggleBtn');
            const amountToggleBtn = getElem('amountToggleBtn');
            const longevityInputs = getElem('longevityInputs');
            const amountInputs = getElem('amountInputs');
            const increasingToggle = getElem('increasingToggle');
            const withdrawalAmountInput = getElem('withdrawalAmount');
            const sustainedYearsInput = getElem('sustainedYears');
            const incomeFrequencySelect = getElem('incomeFrequency');
            const resetBtn = getElem('resetBtn');

            let isLumpsumMode = true, isSipMode = false, isFdMode = false;
            let futureValue = 0;
            let withdrawalMode = 'longevity';
            let corpusChart, corpusBreakdownChart, withdrawalChart;

            const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', {
                style: 'currency', currency: 'INR', minimumFractionDigits: 0
            }).format(amount);
            
            const calculateAndDisplayWithdrawals = () => {
                if (futureValue <= 0) {
                    incomeResult.innerHTML = '';
                    edgeCaseAlerts.innerHTML = '';
                    return;
                }

                const annualRate = parseFloat(annualRateInput.value) / 100;
                const inflationRate = inflationToggle.checked ? parseFloat(inflationRateInput.value) / 100 || 0 : 0;
                const withdrawalFrequency = parseFloat(incomeFrequencySelect.value);
                const periodicRate = annualRate / withdrawalFrequency;
                
                let resultHTML = '';
                let alertsHTML = '';
                let chartData = {};

                if (withdrawalMode === 'longevity') {
                    const withdrawalAmount = parseFloat(withdrawalAmountInput.value) || 0;
                    if(withdrawalAmount <= 0) {
                        incomeResult.innerHTML = '';
                        if(withdrawalChart) withdrawalChart.destroy();
                        return;
                    }

                    const isIncreasing = increasingToggle.checked;
                    
                    if (isIncreasing && annualRate > 0 && annualRate < inflationRate) {
                        alertsHTML += `
                            <div class="alert-box alert-warning">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                <div><strong>Warning:</strong> Your expected return rate (${(annualRate*100).toFixed(1)}%) is lower than inflation (${(inflationRate*100).toFixed(1)}%). Your savings will lose purchasing power and deplete much faster than expected.</div>
                            </div>`;
                    }
                    const annualWithdrawal = withdrawalAmount * withdrawalFrequency;
                    const withdrawalRate = (annualWithdrawal / futureValue) * 100;
                    if (withdrawalRate > 10) { 
                         alertsHTML += `
                            <div class="alert-box alert-info">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" /></svg>
                                <div><strong>Heads Up:</strong> Your planned withdrawal rate is <strong>${withdrawalRate.toFixed(1)}%</strong> per year. This is considered high and will cause your principal to deplete quickly. Financial planners often recommend a rate of 4-5%.</div>
                            </div>`;
                    }
                    let periods = 0, currentCorpus = futureValue, maxSimulationPeriods = 60 * withdrawalFrequency;
                    let corpusHistory = [futureValue], yearLabels = [0], currentWithdrawal = withdrawalAmount;
                    while (currentCorpus > 0 && periods < maxSimulationPeriods) { currentCorpus = currentCorpus * (1 + periodicRate); if(isIncreasing && periods > 0 && periods % withdrawalFrequency === 0) { currentWithdrawal *= (1 + inflationRate); } currentCorpus -= currentWithdrawal; periods++; corpusHistory.push(Math.max(0, currentCorpus)); yearLabels.push(periods / withdrawalFrequency); }
                    const finalCorpus = Math.max(0, currentCorpus); const years = Math.floor(periods / withdrawalFrequency); const remainingPeriods = periods % withdrawalFrequency; const frequencyText = { 12: 'month(s)', 4: 'quarter(s)', 2: 'half-year(s)', 1: 'year(s)' }[withdrawalFrequency];
                    resultHTML = `
                        <h3 class="font-bold mb-4 text-xl text-left">Your Withdrawal Plan</h3>
                        <div class="grid md:grid-cols-2 gap-4 text-left">
                            <div class="result-card bg-green-50 border-green-200 p-4 flex flex-col justify-center">
                                <div class="label">Your Money Will Last For</div>
                                <div class="value text-2xl text-green-700 mt-2">${periods >= maxSimulationPeriods ? '50+ Years' : `${years} years & ${remainingPeriods} ${frequencyText}`}</div>
                                ${periods >= maxSimulationPeriods ? `<p class="text-sm text-green-600 mt-1">Your money is projected to last indefinitely at this rate.</p>` : ''}
                            </div>
                            <div class="result-card bg-gray-50 border-gray-200 p-4 flex flex-col justify-center">
                                <div class="label">Remaining Balance</div>
                                <div class="value text-xl mt-1 break-all">${formatCurrency(finalCorpus)}</div>
                                <p class="text-xs text-gray-500 mt-1">The projected balance after the withdrawal period.</p>
                            </div>
                        </div>
                    `;
                    chartData = { labels: yearLabels, data: corpusHistory };

                } else if (withdrawalMode === 'amount') {
                    const sustainedYears = parseFloat(sustainedYearsInput.value) || 0;
                    if (sustainedYears <= 0) {
                        incomeResult.innerHTML = '';
                        if (withdrawalChart) withdrawalChart.destroy();
                        return;
                    }
                    
                    const periods = sustainedYears * withdrawalFrequency;
                    const withdrawalAmount = (periodicRate === 0) ? futureValue / periods : (futureValue * periodicRate) / (1 - Math.pow(1 + periodicRate, -periods));

                    let corpusHistory = [futureValue];
                    let yearLabels = [0];
                    let corpusForChart = futureValue;
                    for (let i = 1; i <= periods; i++) {
                         corpusForChart = corpusForChart * (1 + periodicRate) - withdrawalAmount;
                         corpusHistory.push(Math.max(0, corpusForChart));
                         yearLabels.push(i / withdrawalFrequency);
                    }
                    const finalCorpus = Math.max(0, corpusForChart);
                    const frequencyTextSingular = { 12: 'month', 4: 'quarter', 2: 'half-year', 1: 'year' }[withdrawalFrequency];

                     resultHTML = `
                        <h3 class="font-bold mb-4 text-xl text-left">Your Withdrawal Plan</h3>
                        <div class="grid md:grid-cols-2 gap-4 text-left">
                            <div class="result-card bg-blue-50 border-blue-200 p-4 flex flex-col justify-center">
                                <div class="label">You Can Withdraw</div>
                                <div class="value text-2xl text-blue-700 mt-2">${formatCurrency(withdrawalAmount)}</div>
                                <p class="text-sm text-gray-600 mt-1">per ${frequencyTextSingular}, for ${sustainedYears} years.</p>
                            </div>
                            <div class="result-card bg-gray-50 border-gray-200 p-4 flex flex-col justify-center">
                                 <div class="label">Remaining Balance</div>
                                 <div class="value text-xl mt-1 break-all">${formatCurrency(finalCorpus)}</div>
                                 <p class="text-xs text-gray-500 mt-1">The projected balance after ${sustainedYears} years.</p>
                            </div>
                        </div>
                    `;
                    chartData = { labels: yearLabels, data: corpusHistory };
                }
               
                edgeCaseAlerts.innerHTML = alertsHTML;
                incomeResult.innerHTML = resultHTML + `<div class="mt-6"><h3 class="font-semibold text-lg text-gray-700 mb-2 text-left">Corpus Depletion Over Time</h3><div class="w-full h-64 bg-white rounded-lg p-2 border"><canvas id="withdrawalChart"></canvas></div></div>`;
                 if (chartData.labels && chartData.data) { setupWithdrawalChart(chartData); }
            };
            
            const calculateAndDisplayCorpus = () => {
                const mainAmount = parseFloat(mainAmountInput.value);
                const investmentYears = parseFloat(investmentYearsInput.value);
                const annualRate = parseFloat(annualRateInput.value) / 100;
                
                if (isNaN(mainAmount) || mainAmount <= 0 || isNaN(investmentYears) || investmentYears <= 0 || isNaN(annualRate) || annualRate < 0) {
                    if (step1Error) step1Error.textContent = 'Please fill in all fields with valid, positive numbers.';
                    resultsColumn.classList.remove('visible');
                    resultsContent.classList.add('hidden');
                    resultsPlaceholder.classList.remove('hidden');
                    yearlyBreakdown.classList.add('hidden');
                    resetBtn.classList.add('hidden');
                    futureValue = 0;
                    return;
                }
                if (step1Error) step1Error.textContent = '';


                const inflationRate = inflationToggle.checked ? parseFloat(inflationRateInput.value) / 100 || 0 : 0;
                const taxRate = taxToggle.checked ? parseFloat(taxRateInput.value) / 100 || 0 : 0;

                const monthlyRate = annualRate / 12;
                let nominalFutureValue = 0, totalInvested = 0;
                
                if (isLumpsumMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + annualRate), investmentYears);
                    totalInvested = mainAmount;
                } else if (isSipMode) {
                    nominalFutureValue = mainAmount * ((Math.pow(1 + monthlyRate, investmentYears * 12) - 1) / monthlyRate) * (1 + monthlyRate);
                    totalInvested = mainAmount * investmentYears * 12;
                } else if (isFdMode) {
                    nominalFutureValue = mainAmount * Math.pow((1 + annualRate), investmentYears);
                    totalInvested = mainAmount;
                }
                const totalReturns = nominalFutureValue - totalInvested;
                let taxPaid = taxToggle.checked ? totalReturns * taxRate : 0;
                const afterTaxFutureValue = nominalFutureValue - taxPaid;
                futureValue = afterTaxFutureValue; // Set global future value
                const realFutureValue = afterTaxFutureValue / Math.pow((1 + inflationRate), investmentYears);

                let corpusHistoryNominal = [], corpusHistoryReal = [], yearsLabels = [];
                let yearlyBreakdownHTML = '';
                let lastYearEndValue = 0;
                let cumulativeInvested = 0;

                for (let year = 1; year <= investmentYears; year++) { 
                    yearsLabels.push(year); 
                    let currentNominalCorpus; 
                    let yearInvested = 0;

                    if (isSipMode) { 
                        currentNominalCorpus = mainAmount * ((Math.pow(1 + monthlyRate, year * 12) - 1) / monthlyRate) * (1 + monthlyRate); 
                        yearInvested = mainAmount * 12;
                        cumulativeInvested += yearInvested;
                    } else { 
                        currentNominalCorpus = mainAmount * Math.pow((1 + annualRate), year); 
                        cumulativeInvested = mainAmount;
                    } 
                    corpusHistoryNominal.push(currentNominalCorpus); 
                    corpusHistoryReal.push(currentNominalCorpus / Math.pow((1 + inflationRate), year)); 

                    const interestEarned = currentNominalCorpus - lastYearEndValue - yearInvested;
                    yearlyBreakdownHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2 font-medium text-gray-900">${year}</td>
                            <td class="px-4 py-2">${formatCurrency(cumulativeInvested)}</td>
                            <td class="px-4 py-2 text-green-600">${formatCurrency(interestEarned)}</td>
                            <td class="px-4 py-2 font-semibold text-gray-900">${formatCurrency(currentNominalCorpus)}</td>
                        </tr>
                    `;
                    lastYearEndValue = currentNominalCorpus;
                }
                
                // Manually add year 0 to the start of the labels array for the chart
                yearsLabels.unshift(0);

                corpusResult.innerHTML = `
                    <div class="text-center bg-white p-4 rounded-lg border mb-4">
                        <p class="text-base text-gray-600">After ${investmentYears} years, you'll have:</p>
                        <p class="text-3xl font-extrabold text-red-600">${formatCurrency(afterTaxFutureValue)}</p>
                        <p class="text-sm mt-1 text-gray-500">Today's Value: <strong class="text-green-700 ml-1">${formatCurrency(realFutureValue)}</strong></p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-4 text-left">
                        <div class="h-64 relative">
                            <canvas id="corpusBreakdownChart"></canvas>
                        </div>
                        <div class="space-y-2">
                             <div class="result-card bg-blue-50 border-blue-200">
                                <div class="label">Total Invested</div>
                                <div class="value">${formatCurrency(totalInvested)}</div>
                            </div>
                             <div class="result-card bg-green-50 border-green-200">
                                <div class="label">Net Returns</div>
                                <div class="value text-green-600">${formatCurrency(totalReturns)}</div>
                            </div>
                            <div class="result-card bg-red-50 border-red-200">
                                <div class="label">Taxes Paid</div>
                                <div class="value text-red-600">${formatCurrency(taxPaid)}</div>
                            </div>
                        </div>
                    </div>`;

                resultsPlaceholder.classList.add('hidden');
                resultsContent.classList.remove('hidden');
                resultsColumn.classList.add('visible');
                yearlyBreakdown.classList.remove('hidden');
                yearlyBreakdownBody.innerHTML = yearlyBreakdownHTML;
                
                resetBtn.classList.remove('hidden');

                setupChart({ labels: yearsLabels, nominal: [isSipMode ? 0 : mainAmount, ...corpusHistoryNominal], real: [isSipMode ? 0 : mainAmount, ...corpusHistoryReal] });
                setupBreakdownChart(totalInvested, totalReturns);
                calculateAndDisplayWithdrawals();
            };

            const syncInputs = (input, slider) => {
                const updateSliderFill = () => {
                    if (!slider || !slider.min || !slider.max) return;
                    const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
                    slider.style.setProperty('--fill-percentage', `${percentage}%`);
                };
                input.addEventListener('input', (e) => {
                    slider.value = e.target.value;
                    updateSliderFill();
                });
                slider.addEventListener('input', (e) => {
                    input.value = e.target.value;
                    updateSliderFill();
                });
                updateSliderFill();
            };

            // This block will fail if the elements don't exist.
            // Let's ensure they are found before adding listeners.
            if(mainAmountInput && mainAmountSlider) syncInputs(mainAmountInput, mainAmountSlider);
            if(investmentYearsInput && investmentYearsSlider) syncInputs(investmentYearsInput, investmentYearsSlider);
            if(annualRateInput && annualRateSlider) syncInputs(annualRateInput, annualRateSlider);
            if(inflationRateInput && inflationRateSlider) syncInputs(inflationRateInput, inflationRateSlider);
            if(taxRateInput && taxRateSlider) syncInputs(taxRateInput, taxRateSlider);

            const setupChart = (data) => {
                const ctx = getElem('corpusChart').getContext('2d');
                if (corpusChart) corpusChart.destroy();
                corpusChart = new Chart(ctx, {
                    type: 'line', data: {
                        labels: data.labels, datasets: [{
                            label: 'Nominal Value', data: data.nominal, borderColor: '#E34037', tension: 0.1, fill: false, pointRadius: 0
                        },{
                            label: 'Real Value (Inflation Adjusted)', data: data.real, borderColor: '#4ade80', tension: 0.1, fill: false, pointRadius: 0
                        }]
                    }, options: { responsive: true, scales: { x: { title: { display: true, text: 'Years' } }, y: { title: { display: true, text: 'Corpus Value' }, beginAtZero: true, ticks: { callback: (value) => formatCurrency(value) } } } }
                });
            };

            const setupBreakdownChart = (invested, returns) => {
                const canvas = getElem('corpusBreakdownChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (corpusBreakdownChart) {
                    corpusBreakdownChart.destroy();
                }
                corpusBreakdownChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Total Investment', 'Net Returns'],
                        datasets: [{
                            data: [invested, returns],
                            backgroundColor: ['#3b82f6', '#22c55e'],
                            borderColor: ['#ffffff', '#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };
            const setupWithdrawalChart = (chartData) => {
                const canvas = getElem('withdrawalChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (withdrawalChart) withdrawalChart.destroy();
                withdrawalChart = new Chart(ctx, {
                    type: 'line', data: {
                        labels: chartData.labels, datasets: [{
                            label: 'Remaining Corpus', data: chartData.data, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.1, pointRadius: 0
                        }]
                    }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Years Into Withdrawal' } }, y: { title: { display: true, text: 'Corpus Value' }, beginAtZero: true, ticks: { callback: (value) => formatCurrency(value) } } }, plugins: { legend: { display: false } } }
                });
            };

            const toggleMode = (mode) => {
                isLumpsumMode = mode === 'lumpsum';
                isSipMode = mode === 'sip';
                isFdMode = mode === 'fd';

                lumpsumToggleBtn.classList.toggle('active', isLumpsumMode);
                sipToggleBtn.classList.toggle('active', isSipMode);
                fdToggleBtn.classList.toggle('active', isFdMode);

                if (isLumpsumMode) {
                    calculatorTitle.textContent = 'Lump-Sum Investment';
                    mainAmountLabelText.textContent = 'Lump-Sum Amount (₹):';
                    mainAmountTooltip.textContent = 'The total single amount you plan to invest at the beginning.';
                    mainAmountInput.placeholder = 'e.g., 100000';
                    mainAmountSlider.max = "10000000";
                    mainAmountInput.min = "1000";
                    mainAmountInput.max = "10000000";
                    mainAmountInput.value = "100000";
                    mainAmountSlider.value = "100000";
                } else if (isSipMode) {
                    calculatorTitle.textContent = 'SIP to Fixed Income';
                    mainAmountLabelText.textContent = 'Monthly SIP Amount (₹):';
                    mainAmountTooltip.textContent = 'The fixed amount you will invest every month.';
                    mainAmountInput.placeholder = 'e.g., 5000';
                    mainAmountSlider.max = "100000";
                    mainAmountInput.min = "500";
                    mainAmountInput.max = "100000";
                    mainAmountInput.value = "5000";
                    mainAmountSlider.value = "5000";
                } else if (isFdMode) {
                    calculatorTitle.textContent = 'Fixed Deposit (FD)';
                    mainAmountLabelText.textContent = 'FD Amount (₹):';
                    mainAmountTooltip.textContent = 'The one-time principal amount you are depositing in the Fixed Deposit.';
                    mainAmountInput.placeholder = 'e.g., 500000';
                    mainAmountSlider.max = "50000000";
                    mainAmountInput.min = "5000";
                    mainAmountInput.max = "50000000";
                    mainAmountInput.value = "500000";
                    mainAmountSlider.value = "500000";
                }
                syncInputs(mainAmountInput, mainAmountSlider);
                calculateAndDisplayCorpus();
            };

                resetUI = () => {
                resultsColumn.classList.remove('visible');
                setTimeout(() => {
                    resultsContent.classList.add('hidden');
                    resultsPlaceholder.classList.remove('hidden');
                }, 300);
                step1Error.textContent = '';
                incomeResult.innerHTML = '';
                edgeCaseAlerts.innerHTML = '';
                yearlyBreakdown.classList.add('hidden');
                yearlyBreakdownBody.innerHTML = '';
                if (corpusChart) corpusChart.destroy();
                if (corpusBreakdownChart) corpusBreakdownChart.destroy();
                if (withdrawalChart) withdrawalChart.destroy();
                resetBtn.classList.add('hidden');
            };
            
            const resetAll = () => {
                mainAmountInput.value = "100000";
                mainAmountSlider.value = "100000";
                investmentYearsInput.value = "10";
                investmentYearsSlider.value = "10";
                annualRateInput.value = "12";
                annualRateSlider.value = "12";
                inflationRateInput.value = "6";
                inflationRateSlider.value = "6";
                inflationToggle.checked = false;
                handleInflationToggle();
                taxRateInput.value = "10";
                taxRateSlider.value = "10";
                taxToggle.checked = false;
                handleTaxToggle();
                
                syncInputs(mainAmountInput, mainAmountSlider);
                syncInputs(investmentYearsInput, investmentYearsSlider);
                syncInputs(annualRateInput, annualRateSlider);
                syncInputs(inflationRateInput, inflationRateSlider);
                syncInputs(taxRateInput, taxRateSlider);

                withdrawalAmountInput.value = '';
                sustainedYearsInput.value = '';
                toggleWithdrawalMode('longevity');
                toggleMode('lumpsum');
            };

            const toggleWithdrawalMode = (mode) => {
                withdrawalMode = mode;
                if (mode === 'longevity') {
                    longevityToggleBtn.classList.add('active');
                    amountToggleBtn.classList.remove('active');
                    longevityInputs.classList.remove('hidden');
                    amountInputs.classList.add('hidden');
                } else {
                    longevityToggleBtn.classList.remove('active');
                    amountToggleBtn.classList.add('active');
                    longevityInputs.classList.add('hidden');
                    amountInputs.classList.remove('hidden');
                }
                calculateAndDisplayWithdrawals();
            };

            const handleInflationToggle = () => {
                if(inflationToggle.checked) {
                    inflationInputsContainer.classList.add('open');
                    inflationRateInput.disabled = false;
                    inflationRateSlider.disabled = false;
                } else {
                    inflationInputsContainer.classList.remove('open');
                    inflationRateInput.disabled = true;
                    inflationRateSlider.disabled = true;
                }
            };

            const handleTaxToggle = () => {
                if (taxToggle.checked) {
                    taxInputsContainer.classList.add('open');
                    taxRateInput.disabled = false;
                    taxRateSlider.disabled = false;
                } else {
                    taxInputsContainer.classList.remove('open');
                    taxRateInput.disabled = true;
                    taxRateSlider.disabled = true;
                }
            };
            
            const setupEventListeners = () => {
                const allInputs = document.querySelectorAll('input[type="number"], input[type="range"], input[type="checkbox"], select');
                allInputs.forEach(input => {
                    input.addEventListener('input', calculateAndDisplayCorpus);
                    input.addEventListener('change', calculateAndDisplayCorpus); 
                });

                const withdrawalInputs = [withdrawalAmountInput, sustainedYearsInput, incomeFrequencySelect, increasingToggle];
                withdrawalInputs.forEach(input => {
                    input.addEventListener('input', calculateAndDisplayWithdrawals);
                    input.addEventListener('change', calculateAndDisplayWithdrawals);
                });

                lumpsumToggleBtn.addEventListener('click', () => toggleMode('lumpsum'));
                sipToggleBtn.addEventListener('click', () => toggleMode('sip'));
                fdToggleBtn.addEventListener('click', () => toggleMode('fd'));
                resetBtn.addEventListener('click', resetAll);
                
                document.querySelectorAll('.btn-rate').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const rate = e.target.getAttribute('data-rate');
                        annualRateInput.value = rate;
                        annualRateSlider.value = rate;
                        syncInputs(annualRateInput, annualRateSlider);
                        calculateAndDisplayCorpus();
                    });
                });
                
                longevityToggleBtn.addEventListener('click', () => toggleWithdrawalMode('longevity'));
                amountToggleBtn.addEventListener('click', () => toggleWithdrawalMode('amount'));

                inflationToggle.addEventListener('change', handleInflationToggle);
                inflationHeader.addEventListener('click', (e) => {
                    if (e.target.id === 'inflationToggle' || e.target.classList.contains('toggle-slider')) return;
                    inflationToggle.checked = !inflationToggle.checked;
                    handleInflationToggle();
                });
                
                taxToggle.addEventListener('change', handleTaxToggle);
                taxHeader.addEventListener('click', (e) => {
                    if (e.target.id === 'taxToggle' || e.target.classList.contains('toggle-slider')) return;
                    taxToggle.checked = !taxToggle.checked;
                    handleTaxToggle();
                });
            };

            // Initial Setup
            // Check if critical elements exist before proceeding
            if (mainAmountInput) {
                handleTaxToggle();
                handleInflationToggle();
                setupEventListeners();
                calculateAndDisplayCorpus(); // Initial calculation on page load
            } else {
                console.error("Initialization failed: Critical input elements not found in the DOM.");
            }
        });
    </script>
</body>
</html>
